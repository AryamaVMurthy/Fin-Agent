name: release

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org"

      - name: Install Python runtime deps
        run: |
          python -m venv .venv312
          .venv312/bin/pip install --upgrade pip
          .venv312/bin/pip install duckdb fastapi pydantic uvicorn cryptography

      - name: Install wrapper deps
        run: |
          cd apps/fin-agent
          npm ci

      - name: Publish readiness gate
        run: |
          bash scripts/publish-readiness.sh --skip-auth --allow-dirty

      - name: Strict deterministic E2E
        run: |
          bash scripts/e2e-full.sh --skip-doctor

  package:
    needs: verify
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build release artifact
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [[ "${VERSION}" == "${GITHUB_REF_NAME}" ]]; then
            VERSION="$(date -u +%Y.%m.%d)"
          fi
          bash scripts/release-tui.sh --version "${VERSION}"

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fin-agent-release-artifacts
          path: |
            dist/*.tar.gz
            dist/*.sha256

      - name: Publish GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.tar.gz
            dist/*.sha256

  npm_publish:
    needs: verify
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: startsWith(github.ref, 'refs/tags/v') && secrets.NPM_TOKEN != ''

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org"

      - name: Install wrapper deps
        run: |
          cd apps/fin-agent
          npm ci

      - name: Publish to npm
        run: |
          cd apps/fin-agent
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
